generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGEMENT
  HR_ADMIN
  MANAGER
  EMPLOYEE
}

enum RegularizationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum SessionType {
  CHECK_IN
  CHECK_OUT
}

// ─── Models ───────────────────────────────────────────────

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String
  password           String
  role               Role     @default(EMPLOYEE)
  departmentId       String?
  entityId           String?
  managerId          String?
  locationId         String?
  avatarUrl          String?
  phone              String?
  employeeCode       String?  @unique
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  department     Department?       @relation(fields: [departmentId], references: [id])
  entity         Entity?           @relation(fields: [entityId], references: [id])
  manager        User?             @relation("ManagerToEmployee", fields: [managerId], references: [id])
  location       Location?         @relation(fields: [locationId], references: [id])
  subordinates   User[]            @relation("ManagerToEmployee")
  sessions       AttendanceSession[]
  dailySummaries DailySummary[]
  regularizations     Regularization[]   @relation("RegularizationEmployee")
  approvedRegularizations Regularization[] @relation("RegularizationApprover")
  notifications  Notification[]
  auditLogs      AuditLog[]
  leaveBalances  LeaveBalance[]
  leaveRequests  LeaveRequest[]    @relation("LeaveEmployee")
  approvedLeaves LeaveRequest[]    @relation("LeaveApprover")

  @@index([email])
  @@index([departmentId])
  @@index([entityId])
  @@index([managerId])
  @@index([locationId])
  @@index([role])
}

model Department {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
}

model Entity {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
}

model EmailConfig {
  id        String   @id @default(cuid())
  provider  String   @default("custom") // gmail, microsoft365, custom
  host      String
  port      Int      @default(587)
  secure    Boolean  @default(false)
  username  String
  password  String
  fromName  String
  fromEmail String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AttendanceSession {
  id          String      @id @default(cuid())
  userId      String
  type        SessionType
  timestamp   DateTime    @default(now())
  latitude    Float
  longitude   Float
  address     String?
  deviceInfo  String?
  isAutoOut   Boolean     @default(false)
  createdAt   DateTime    @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([userId, type])
  @@index([timestamp])
}

model DailySummary {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @db.Date
  firstCheckIn    DateTime?
  lastCheckOut    DateTime?
  totalWorkMins   Int      @default(0)
  totalBreakMins  Int      @default(0)
  overtimeMins    Int      @default(0)
  sessionCount    Int      @default(0)
  status          String   @default("PRESENT") // PRESENT, ABSENT, HALF_DAY, LATE, ON_LEAVE
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
  @@index([status])
}

model Regularization {
  id           String               @id @default(cuid())
  employeeId   String
  approverId   String?
  date         DateTime             @db.Date
  type         String               // MISSED_CHECK_IN, MISSED_CHECK_OUT, WRONG_TIME
  reason       String
  requestedTime DateTime?
  status       RegularizationStatus @default(PENDING)
  reviewNote   String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  employee     User                 @relation("RegularizationEmployee", fields: [employeeId], references: [id])
  approver     User?                @relation("RegularizationApprover", fields: [approverId], references: [id])

  @@index([employeeId, date])
  @@index([approverId])
  @@index([status])
}

model GeoFence {
  id        String   @id @default(cuid())
  name      String
  latitude  Float
  longitude Float
  radiusM   Int      @default(200) // radius in meters
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AppConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  metadata  String?  // JSON string
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model Location {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
}

model LeaveType {
  id              String   @id @default(cuid())
  name            String   @unique
  code            String   @unique
  isFixed         Boolean  @default(true)
  defaultDays     Float    @default(0)
  accrualPerMonth Float?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  balances        LeaveBalance[]
  requests        LeaveRequest[]
}

model LeaveBalance {
  id           String   @id @default(cuid())
  userId       String
  leaveTypeId  String
  year         Int
  allocated    Float    @default(0)
  used         Float    @default(0)
  pending      Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveType    LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([userId, leaveTypeId, year])
  @@index([userId, year])
}

model LeaveRequest {
  id           String      @id @default(cuid())
  userId       String
  leaveTypeId  String
  startDate    DateTime    @db.Date
  endDate      DateTime    @db.Date
  days         Float
  reason       String
  status       LeaveStatus @default(PENDING)
  approverId   String?
  reviewNote   String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user         User        @relation("LeaveEmployee", fields: [userId], references: [id], onDelete: Cascade)
  leaveType    LeaveType   @relation(fields: [leaveTypeId], references: [id])
  approver     User?       @relation("LeaveApprover", fields: [approverId], references: [id])

  @@index([userId, status])
  @@index([approverId])
  @@index([startDate, endDate])
}
